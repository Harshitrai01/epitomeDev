<template>
    <!-- Check if the component should be displayed -->
    <template if:true={showComponent}>
        <!-- Check if the modal should be open -->
        <template if:true={isModalOpen}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <!-- Close button for the modal -->
                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}>
                            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        </button>
                        <h2 class="slds-text-heading_medium">Booking Form</h2>
                    </header>

                    <!-- Modal/Popup Body -->
                    <div class="slds-modal__content slds-p-around_medium">
                        <div class="card-container">
                            <article class="slds-card">
                                <div class="slds-card__body slds-card__body_inner">
                                    <!-- Show spinner while loading -->
                                    <template if:true={isLoading}>
                                        <lightning-spinner variant="brand" alternative-text="Loading" size="large">
                                        </lightning-spinner>
                                    </template>
                                    <lightning-accordion allow-multiple-sections-open
                                        active-section-name={activeSections} class="applicant-details-sections">
                                        <!-- Project Information Section -->
                                        <lightning-accordion-section name="C" label="Project Information">
                                            <lightning-layout multiple-rows>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-combobox name="progress" label="Select Project"
                                                        placeholder="Select Project" options={projects}
                                                        onchange={handleProjectSelection}
                                                        value={bookingFormData.projectId}
                                                        data-label="primaryApplicantRequiredFields" required>
                                                    </lightning-combobox>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-combobox name="progress" label="Select Phase"
                                                        placeholder="Select Phase" options={phases}
                                                        onchange={handlePhaseSelection} value={bookingFormData.phaseId}
                                                        data-label="primaryApplicantRequiredFields" required>
                                                    </lightning-combobox>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-combobox data-label="primaryApplicantRequiredFields"
                                                        type="text" variant="standard" name="typeOfBooking"
                                                        label="Type of Booking" onchange={handleAccountChange}
                                                        value={bookingFormData.typeOfBooking}
                                                        options={picklistOptions.typeOfBookingOptions} required>
                                                    </lightning-combobox>
                                                </lightning-layout-item>
                                            </lightning-layout>
                                        </lightning-accordion-section>

                                        <!-- Primary Information Section -->
                                        <lightning-accordion-section name="A" label="Primary Information"
                                            class="accordion-section">
                                            <lightning-layout multiple-rows>
                                                <div class="form-container">
                                                    <lightning-layout-item flexibility="auto" padding="around-small"
                                                        size="12" small-device-size="12" medium-device-size="6"
                                                        large-device-size="6">
                                                        <label class="custom-label" required> <span class="required">*</span>Is the Account already existing?</label>
                                                    </lightning-layout-item>
                                                    <lightning-layout-item flexibility="auto" padding="around-small"
                                                        size="12" small-device-size="12" medium-device-size="6"
                                                        large-device-size="6">
                                                        <lightning-combobox name="progress" placeholder="Select Account"
                                                            options={options} onchange={handleCheckboxChange}
                                                            value={value}>
                                                        </lightning-combobox>
                                                    </lightning-layout-item>
                                                </div>

                                                <!-- Second Layout Item with Account Record Picker -->
                                                <template if:false={isAccountExist}>
                                                    <lightning-layout-item flexibility="auto" padding="around-small"
                                                        size="12" small-device-size="12" medium-device-size="6"
                                                        large-device-size="6">
                                                        <lightning-record-picker label="Select Account"
                                                            object-api-name="Account" onchange={handleRecordSelection}
                                                            disabled={isAccountExist}
                                                            data-label="primaryApplicantRequiredFields" required>
                                                        </lightning-record-picker>
                                                    </lightning-layout-item>
                                                </template>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-input data-label="primaryApplicantRequiredFields"
                                                        label="Account Name" type="text" name="accountName"
                                                        onchange={handleAccountChange}
                                                        value={bookingFormData.accountName} data-required="true"
                                                        required></lightning-input>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-input data-label="primaryApplicantRequiredFields"
                                                        type="email" variant="standard" name="accountEmailId"
                                                        label="Email Id" onchange={handleAccountChange}
                                                        value={bookingFormData.accountEmailId} required>
                                                    </lightning-input>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-input data-label="primaryApplicantRequiredFields"
                                                        type="tel" variant="standard" name="accountContactNo"
                                                        label="Contact No" min-length="10" max-length="10"
                                                        message-when-too-short="Enter a valid contact number"
                                                        pattern="[0-9]{10}"
                                                        message-when-pattern-mismatch="Enter a valid contact number format"
                                                        onchange={handleAccountChange}
                                                        value={bookingFormData.accountContactNo} required>
                                                    </lightning-input>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="12"
                                                    large-device-size="12">
                                                    <lightning-input data-label="primaryApplicantRequiredFields"
                                                        type="checkbox" variant="standard"
                                                        name="accountSameAsPermanentAddress"
                                                        label="Same as Permanent Address" onchange={handleAccountChange}
                                                        value={bookingFormData.accountSameAsPermanentAddress}
                                                        checked={bookingFormData.accountSameAsPermanentAddress}>
                                                    </lightning-input>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <lightning-input-address data-label="primaryApplicantRequiredFields"
                                                        name="accountPermanentAddress" address-label="Permanent Address"
                                                        street-label="Street" city-label="City" country-label="Country"
                                                        province-label="State" postal-code-label="Postal Code"
                                                        street={bookingFormData.accountPermanentAddressStreet}
                                                        city={bookingFormData.accountPermanentAddressCity}
                                                        country={bookingFormData.accountPermanentAddressCountry}
                                                        province={bookingFormData.accountPermanentAddressState}
                                                        postal-code={bookingFormData.accountPermanentAddressPostalCode}
                                                        onchange={handlePermanentAddressChange} required>
                                                    </lightning-input-address>
                                                </lightning-layout-item>
                                                <lightning-layout-item flexibility="auto" padding="around-small"
                                                    size="12" small-device-size="12" medium-device-size="6"
                                                    large-device-size="6">
                                                    <template if:true={bookingFormData.accountSameAsPermanentAddress}>
                                                        <lightning-input-address
                                                            data-label="primaryApplicantRequiredFields"
                                                            data-name="accountCorrespondenceAddress"
                                                            name="accountCorrespondenceAddress"
                                                            address-label="Correspondence Address" street-label="Street"
                                                            street-name="accountCorrespondenceAddressStreet"
                                                            city-label="City" country-label="Country"
                                                            province-label="State" postal-code-label="Postal Code"
                                                            street={bookingFormData.accountCorrespondenceAddressStreet}
                                                            city={bookingFormData.accountCorrespondenceAddressCity}
                                                            country={bookingFormData.accountCorrespondenceAddressCountry}
                                                            province={bookingFormData.accountCorrespondenceAddressState}
                                                            postal-code={bookingFormData.accountCorrespondenceAddressPostalCode}
                                                            onchange={handleCorrespondenceAddressChange}
                                                            disabled={bookingFormData.accountSameAsPermanentAddress}>
                                                        </lightning-input-address>
                                                    </template>
                                                    <template if:false={bookingFormData.accountSameAsPermanentAddress}>
                                                        <lightning-input-address
                                                            data-label="primaryApplicantRequiredFields"
                                                            data-name="accountCorrespondenceAddress"
                                                            name="accountCorrespondenceAddress"
                                                            address-label="Correspondence Address" street-label="Street"
                                                            street-name="accountCorrespondenceAddressStreet"
                                                            city-label="City" country-label="Country"
                                                            province-label="State" postal-code-label="Postal Code"
                                                            street={bookingFormData.accountCorrespondenceAddressStreet}
                                                            city={bookingFormData.accountCorrespondenceAddressCity}
                                                            country={bookingFormData.accountCorrespondenceAddressCountry}
                                                            province={bookingFormData.accountCorrespondenceAddressState}
                                                            postal-code={bookingFormData.accountCorrespondenceAddressPostalCode}
                                                            onchange={handleCorrespondenceAddressChange}
                                                            required={bookingFormData.accountSameAsPermanentAddressNeeded}>
                                                        </lightning-input-address>
                                                    </template>
                                                </lightning-layout-item>
                                            </lightning-layout>
                                        </lightning-accordion-section>

                                        <!-- Looping through co-applicants' contact details -->
                                        <template for:each={bookingFormData.listOfCoApplicant} for:item="contact">
                                            <div key={contact.id} class="contact-container">
                                                <lightning-accordion-section name="B" label="Contact Information">
                                                    <lightning-layout multiple-rows>
                                                        <template if:true={isAccountSelected}>
                                                            <div class="form-container">
                                                                <lightning-layout-item flexibility="auto"
                                                                    padding="around-small" size="12"
                                                                    small-device-size="12" medium-device-size="6"
                                                                    large-device-size="6">
                                                                    <!-- Determines if the contact already exists -->
                                                                    <label class="custom-label" required> <span class="required">*</span>Is the contact already existing?</label>
                                                                </lightning-layout-item>
                                                                <lightning-layout-item flexibility="auto"
                                                                    padding="around-small" size="12"
                                                                    small-device-size="12" medium-device-size="6"
                                                                    large-device-size="6">
                                                                    <lightning-combobox name="progress"
                                                                        placeholder="Select Contact"
                                                                        options={contactOptions}
                                                                        onchange={handleContactCheckboxChange}
                                                                        data-contact-id={contact.id}
                                                                        value={contactValue}>
                                                                    </lightning-combobox>
                                                                </lightning-layout-item>
                                                            </div>

                                                            <!-- Second Layout Item with Account Record Picker -->
                                                            <template if:false={contact.isContactExist}>
                                                                <lightning-layout-item flexibility="auto"
                                                                    padding="around-small" size="12"
                                                                    small-device-size="12" medium-device-size="6"
                                                                    large-device-size="6">
                                                                    <lightning-combobox name="contacts"
                                                                        label="Select Contact"
                                                                        placeholder="Select Contact From Here..."
                                                                        options={contacts} value={contact.contactId}
                                                                        onchange={handleContactRecordSelection}
                                                                        data-contact-id={contact.id}
                                                                        data-label="primaryApplicantRequiredFields"
                                                                        required>
                                                                    </lightning-combobox>
                                                                </lightning-layout-item>
                                                            </template>
                                                        </template>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input label="Contact Name"
                                                                data-label="primaryApplicantRequiredFields" type="text"
                                                                name="contactName" data-contact-id={contact.id}
                                                                onchange={handleValueChange} value={contact.contactName}
                                                                required></lightning-input>
                                                        </lightning-layout-item>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input data-label="primaryApplicantRequiredFields"
                                                                onchange={handleValueChange} name="contactAadhaar"
                                                                type="text" variant="standard" label="Aadhaar Card"
                                                                min-length="12" max-length="12"
                                                                message-when-too-short="Enter a valid aadhaar card number"
                                                                pattern="[0-9]{12}"
                                                                message-when-pattern-mismatch="Enter a valid aadhaar card number format"
                                                                data-contact-id={contact.id}
                                                                value={contact.contactAadhaar} required>
                                                            </lightning-input>
                                                        </lightning-layout-item>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input data-label="primaryApplicantRequiredFields"
                                                                type="text" variant="standard" name="contactPan"
                                                                label="Pan Card" onchange={handleValueChange}
                                                                min-length="10" max-length="10"
                                                                message-when-too-short="Enter a valid pan card number"
                                                                pattern="[A-Za-z]{5}[0-9]{4}[A-Za-z]{1}"
                                                                message-when-pattern-mismatch="Enter a valid pan card number format"
                                                                data-contact-id={contact.id} value={contact.contactPan}
                                                                required>
                                                            </lightning-input>
                                                        </lightning-layout-item>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input label="Date of Birth"
                                                                data-label="primaryApplicantRequiredFields" type="date"
                                                                name="contactDOB" data-contact-id={contact.id}
                                                                onchange={handleValueChange} value={contact.contactDOB}
                                                                required></lightning-input>
                                                        </lightning-layout-item>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input data-label="primaryApplicantRequiredFields"
                                                                type="email" variant="standard" name="contactEmail"
                                                                label="Email Id" data-contact-id={contact.id}
                                                                onchange={handleValueChange}
                                                                value={contact.contactEmail} required>
                                                            </lightning-input>
                                                        </lightning-layout-item>
                                                        <lightning-layout-item flexibility="auto" padding="around-small"
                                                            size="12" small-device-size="12" medium-device-size="6"
                                                            large-device-size="6">
                                                            <lightning-input data-label="primaryApplicantRequiredFields"
                                                                type="tel" variant="standard" name="contactPhone"
                                                                label="Contact No" data-contact-id={contact.id}
                                                                min-length="10" max-length="10"
                                                                message-when-too-short="Enter a valid contact number"
                                                                pattern="[0-9]{10}"
                                                                message-when-pattern-mismatch="Enter a valid contact number format"
                                                                onchange={handleValueChange}
                                                                value={contact.contactPhone} required>
                                                            </lightning-input>
                                                        </lightning-layout-item>
                                                    </lightning-layout>
                                                </lightning-accordion-section>

                                                <!-- Looping through plots associated with contact -->
                                                <template for:each={contact.plots} for:item="plot">
                                                    <div key={plot.id} class="plot-container">
                                                        <div class="padded-section">
                                                            <lightning-accordion-section name="D"
                                                                label="Plot Information">
                                                                <lightning-layout multiple-rows>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        
                                                                        <!-- <lightning-record-picker label="Select Plot"
                                                                            object-api-name="Unit__c"
                                                                            onchange={handleValueChange} name="plotName"
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            filter={plot.filterCriteria}
                                                                            data-label="primaryApplicantRequiredFields"
                                                                            required></lightning-record-picker> -->
                                                                     <span class="required">*</span>
    <c-generate-custom-lookup
     
        icon-name="standard:account"
        name="plotName"
        s-object-api-name="Unit__c"
        label="Select Plot"
        data-contact-id={contact.id}
        data-plot-id={plot.id}
        onlookupupdate={handleValueChange}
        selectedplotid={selectedPlotIds}
        onlookupremove={lookupRecordRemove}
        placeholder="search.."
        phase-id={bookingFormData.phaseId}
        project-id={bookingFormData.projectId}
        >
    </c-generate-custom-lookup>


                                                                        <!-- Calling custom searchable combobox from child component-->
                                                                        <!-- <c-custom-lookup-cmp label="Select Plot"
                                                                            placeholder="Search and Select a Plot"
                                                                            object-name="Unit__c" field-name="Name"
                                                                            name="plotName" onselect={handleValueChange}
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            contact-id={contact.id} plot-id={plot.id}
                                                                            onclearplots={handleClearPlot}
                                                                            phase-id={bookingFormData.phaseId}> -->
                                                                        <!-- </c-custom-lookup-cmp> -->
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        <lightning-input
                                                                            data-label="primaryApplicantRequiredFields"
                                                                            type="number" data-contact-id={contact.id}
                                                                            data-plot-id={plot.id} variant="standard"
                                                                            name="unitOppAmount"
                                                                            label="First Booking Amount"
                                                                            onchange={handleValueChange}
                                                                            value={plot.unitOppAmount}
                                                                            formatter="currency" step="0.01" required>
                                                                        </lightning-input>
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        <lightning-input label="Plot Size" type="text"
                                                                            name="unitPlotSize"
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            onchange={handleValueChange}
                                                                            value={plot.unitPlotSize} required disabled>
                                                                        </lightning-input>
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        <lightning-input label="Plot Price" type="text"
                                                                            name="unitPlotPrize"
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            onchange={handleValueChange}
                                                                            value={plot.unitPlotPrize} required
                                                                            disabled></lightning-input>
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        <lightning-input label="Plot Facing" type="text"
                                                                            name="unitPlotFacing"
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            onchange={handleValueChange}
                                                                            value={plot.unitPlotFacing} required
                                                                            disabled></lightning-input>
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item flexibility="auto"
                                                                        padding="around-small" size="12"
                                                                        small-device-size="12" medium-device-size="6"
                                                                        large-device-size="6">
                                                                        <lightning-input label="Plot Number" type="text"
                                                                            name="unitPlotUnitCode"
                                                                            data-contact-id={contact.id}
                                                                            data-plot-id={plot.id}
                                                                            onchange={handleValueChange}
                                                                            value={plot.unitPlotUnitCode} required
                                                                            disabled></lightning-input>
                                                                    </lightning-layout-item>
                                                                </lightning-layout>
                                                            </lightning-accordion-section>
                                                        </div>

                                                        <div style="display:flex;justify-content: flex-end;">
                                                            <!--Button for removing plot-->
                                                            <template if:true={plot.showRemoveButton}>
                                                                <lightning-button variant="destructive"
                                                                    label="Remove Plot" data-contact-id={contact.id}
                                                                    data-plot-id={plot.id} onclick={removePlot}>
                                                                </lightning-button>
                                                            </template>
                                                            <!--Button for adding plot-->
                                                            <template if:true={plot.showAddMoreButton}>
                                                                <lightning-button variant="neutral"
                                                                    label="Add More Plot" data-contact-id={contact.id}
                                                                    data-plot-id={plot.id} onclick={addPlot}>
                                                                </lightning-button>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!--Button for removing contact-->
                                                <template if:true={contact.showRemoveButton}>
                                                    <lightning-button variant="destructive" label="Remove Contact"
                                                        data-contact-id={contact.id} onclick={removeContact}>
                                                    </lightning-button>
                                                </template>
                                                <!--Button for adding contact-->
                                                <template if:true={contact.showAddMoreButton}>
                                                    <lightning-button variant="neutral" label="Add More Contact"
                                                        data-contact-id={contact.id} onclick={addContact}>
                                                    </lightning-button>
                                                </template>
                                            </div>
                                        </template>
                                    </lightning-accordion>
                                </div>
                            </article>
                        </div>
                    </div>
                    <footer class="slds-modal__footer">
                        <!--Modal buttons for cancel and save-->
                        <lightning-button label="Cancel" onclick={closeModal}></lightning-button>
                        <lightning-button label="Save" onclick={handleSave}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </template>
</template>